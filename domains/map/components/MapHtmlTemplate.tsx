import { MapMarker, MapRegion } from "@/domains/map/model";

const generateHtmlStructure = (apiKey: string) => {
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
      <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=${apiKey}"></script>
      <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; position: absolute; }
      </style>
    </head>
    <body>
      <div id="map"></div>
  `.trim();
};

const generateInitScript = (region: MapRegion, markers: MapMarker[]) => {
  const webViewMarkers = markers.map((m) => ({
    id: m.id,
    name: m.name,
    latitude: m.latitude,
    longitude: m.longitude,
  }));

  const normalIconSvg = `<svg width="28" height="38" viewBox="0 0 28 38" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse opacity="0.3" cx="14" cy="33.9995" rx="8.57031" ry="3.46338" fill="#1F1F1F"/><path d="M28 14C28 21.7278 20.2934 29.5382 16.3158 33.0547C14.9773 34.2381 13.0227 34.2381 11.6842 33.0547C7.70659 29.5382 0 21.7278 0 14C0 6.26801 6.26801 0 14 0C21.732 0 28 6.26801 28 14Z" fill="#FFD800"/><circle cx="13.8599" cy="14.25" r="11.4233" fill="#F7F5F0"/><path d="M7.17798 13.5137L8.0766 16.511C8.37729 17.5158 9.11361 18.3333 10.0796 18.7271C12.8475 19.8562 15.5808 19.791 18.2818 18.532C19.2241 18.0929 19.9131 17.2414 20.1579 16.224L20.8875 13.1873" fill="#FFD800"/><path d="M16.599 19.6067C14.3947 20.1985 12.1564 20.0383 9.92045 19.1263C8.83027 18.6812 8.00883 17.7728 7.66774 16.634L6.76911 13.6367L7.58673 13.3915L8.48535 16.3889C8.75113 17.276 9.39029 17.9825 10.2386 18.3287C12.8789 19.4063 15.5245 19.3435 18.1016 18.1411C18.9299 17.7549 19.5286 17.0191 19.7436 16.1211L20.4732 13.0845L21.3027 13.2908L20.5731 16.3275C20.2963 17.4806 19.5268 18.4272 18.4627 18.9224C17.8455 19.2107 17.224 19.4377 16.5998 19.6053L16.599 19.6067Z" fill="#1F1F1F"/><path d="M21.6023 11.8799C21.5564 10.2365 18.1144 8.9851 13.9143 9.08473C9.71419 9.18437 6.34649 10.5974 6.39233 12.2407C6.43818 13.8841 9.88021 15.1355 14.0803 15.0359C18.2804 14.9363 21.6481 13.5233 21.6023 11.8799Z" fill="#FFD800"/><path d="M18.1813 14.9142C16.9659 15.2406 15.5609 15.4328 14.0928 15.4681C12.0103 15.518 10.0363 15.2444 8.53597 14.6988C6.90606 14.1067 5.99348 13.2373 5.96551 12.2529C5.91139 10.3116 9.32356 8.76464 13.9024 8.65528C15.985 8.60544 17.9589 8.87898 19.4593 9.42455C21.0892 10.0167 22.0015 10.8851 22.0298 11.8705C22.0577 12.8549 21.1948 13.7663 19.5998 14.4353C19.1662 14.6175 18.6912 14.7773 18.1823 14.914L18.1813 14.9142ZM10.0305 10.0403C8.01469 10.5816 6.79583 11.4504 6.81701 12.2327C6.83337 12.8201 7.58265 13.4391 8.81996 13.8893C10.2236 14.3995 12.0866 14.6549 14.067 14.6069C16.0466 14.5602 17.8936 14.2169 19.267 13.6398C20.4779 13.1319 21.1912 12.4779 21.1746 11.8895C21.1582 11.3021 20.409 10.683 19.1717 10.2329C17.768 9.72262 15.905 9.46723 13.9246 9.51526C12.441 9.55028 11.119 9.74698 10.0302 10.0393L10.0305 10.0403Z" fill="#1F1F1F"/><path d="M13.9882 11.7358C15.7856 11.6934 17.4895 11.9113 18.7867 12.3498C19.0783 12.4487 19.3204 12.5486 19.5224 12.6471C19.713 12.5424 19.8661 12.4422 19.9865 12.3519C20.2776 12.1323 20.2651 11.6909 19.9627 11.4857C19.7085 11.3122 19.3206 11.1098 18.7463 10.9163C17.4492 10.4777 15.7453 10.2599 13.9478 10.3023C12.1504 10.3446 10.4604 10.6435 9.19012 11.1439C8.61983 11.3683 8.24057 11.5928 7.99672 11.7786C7.71538 11.9934 7.7275 12.4293 8.02079 12.6292C8.14804 12.7165 8.30934 12.8113 8.51136 12.9098C8.70781 12.8024 8.9448 12.6898 9.23074 12.5784C10.5013 12.0791 12.1913 11.7802 13.9885 11.7368L13.9882 11.7358Z" fill="#1F1F1F"/><path d="M19.5359 13.1286L19.3391 13.0332C19.1371 12.9348 18.9057 12.842 18.6519 12.7564C17.4008 12.3333 15.7476 12.123 13.9995 12.1644C12.2505 12.206 10.6118 12.4944 9.38619 12.9762C9.13752 13.0741 8.91253 13.178 8.71504 13.2856L8.52346 13.3906L8.32668 13.2952C8.12233 13.1963 7.9383 13.0908 7.7801 12.9828C7.52954 12.8104 7.37435 12.5245 7.36577 12.2169C7.3572 11.9094 7.4962 11.6169 7.73724 11.4329C8.06525 11.1822 8.5018 10.949 9.03229 10.7409C10.3478 10.2238 12.0891 9.91456 13.9347 9.8704C15.7802 9.82624 17.5361 10.0525 18.8793 10.5065C19.4138 10.6873 19.8587 10.8966 20.1992 11.1284C20.456 11.3035 20.6144 11.5931 20.6235 11.9027C20.6327 12.2123 20.4904 12.509 20.2434 12.6957C20.0947 12.8081 19.9214 12.9192 19.7267 13.025L19.5351 13.1299L19.5359 13.1286ZM13.9753 11.3049C15.8209 11.2608 17.5767 11.487 18.9199 11.941C19.1253 12.0107 19.3185 12.0848 19.4974 12.1627C19.5818 12.111 19.6592 12.0579 19.7291 12.0057C19.7641 11.9796 19.7704 11.9456 19.7697 11.9224C19.769 11.8992 19.7611 11.8657 19.7236 11.8412C19.5331 11.7118 19.1858 11.5164 18.6105 11.3231C17.3595 10.9001 15.7062 10.6898 13.9582 10.7311C12.2091 10.7728 10.5704 11.0612 9.34482 11.5429C8.77452 11.7674 8.43647 11.9807 8.25307 12.1203C8.2227 12.1429 8.21685 12.1746 8.21756 12.1978C8.21799 12.2199 8.22533 12.2514 8.25759 12.2728C8.33211 12.3242 8.41542 12.3753 8.50594 12.4246C8.68027 12.3377 8.86995 12.2544 9.07057 12.1749C10.3871 11.6576 12.1274 11.3486 13.9729 11.3045L13.9753 11.3049Z" fill="#1F1F1F"/><path d="M14.0462 13.8196C15.8436 13.7772 17.5336 13.4784 18.8039 12.978C19.0896 12.8656 19.3258 12.7543 19.522 12.6459C19.32 12.5474 19.0765 12.4468 18.7862 12.3486C17.4891 11.9101 15.7852 11.6922 13.9877 11.7346C12.1902 11.777 10.5003 12.0758 9.22999 12.5762C8.94432 12.6886 8.70705 12.8002 8.5106 12.9076C8.71262 13.006 8.95609 13.1067 9.2474 13.2046C10.5445 13.6431 12.2484 13.861 14.0459 13.8186L14.0462 13.8196Z" fill="#F7F5F0"/><path d="M17.8647 13.7381C16.7409 14.0398 15.4283 14.2184 14.0578 14.2509C12.2122 14.2951 10.4564 14.0688 9.11312 13.6148C8.82546 13.5182 8.5614 13.4108 8.32675 13.2977C8.18197 13.2273 8.08777 13.0821 8.0841 12.9204C8.08043 12.7587 8.16501 12.6089 8.30563 12.5322C8.53384 12.4074 8.79115 12.2881 9.07297 12.1779C10.3895 11.6606 12.1298 11.3516 13.9754 11.3075C15.8209 11.2633 17.5768 11.4895 18.92 11.9435C19.2066 12.0404 19.4717 12.1476 19.7054 12.2609C19.8501 12.3313 19.9443 12.4765 19.948 12.6382C19.9527 12.7997 19.8671 12.9497 19.7265 13.0265C19.4983 13.1513 19.241 13.2705 18.9591 13.3807C18.6206 13.514 18.253 13.6338 17.8636 13.7384L17.8647 13.7381ZM9.64352 12.884C10.8595 13.2507 12.4053 13.4308 14.0335 13.3915C15.6631 13.3529 17.1963 13.0995 18.3899 12.6754C17.1739 12.3087 15.6281 12.1286 13.9999 12.1679C12.3703 12.2065 10.8371 12.4599 9.64352 12.884Z" fill="#1F1F1F"/><path d="M14.7038 13.7863C10.663 12.1609 11.5916 10.1864 9.48289 10.2744C8.12008 10.3316 8.13413 9.40508 7.18246 9.31958C6.23079 9.23407 5.55489 9.81786 5.72357 10.9561C5.86744 11.9238 6.60168 12.7008 7.54412 12.937C11.3347 13.8896 13.3868 14.014 14.7028 13.7866L14.7038 13.7863Z" fill="#F7F5F0"/><path d="M16.2665 13.9521L14.7776 14.2103C13.1895 14.4851 10.8594 14.2136 7.44279 13.3544C6.31071 13.07 5.47018 12.1522 5.30131 11.0173C5.17447 10.1665 5.45197 9.66182 5.70682 9.38945C6.05928 9.01174 6.5958 8.83426 7.21711 8.89033C7.76711 8.93992 8.08641 9.21194 8.34382 9.43035C8.63152 9.67519 8.86024 9.86899 9.46213 9.84447C10.6721 9.79376 11.1049 10.3529 11.6068 11.0005C12.12 11.6618 12.8216 12.5678 14.8579 13.3863L16.2641 13.9516L16.2665 13.9521ZM6.68383 9.77909C6.53859 9.81808 6.41877 9.88592 6.33026 9.97989C6.10204 10.2239 6.1044 10.6111 6.14587 10.8931C6.26142 11.6689 6.86407 12.3218 7.64577 12.5187C9.91958 13.0907 11.6811 13.3956 13.0364 13.4463C11.8913 12.7596 11.3573 12.0705 10.9368 11.5281C10.4806 10.9396 10.2729 10.6721 9.50294 10.7039C8.56716 10.7434 8.14019 10.3788 7.79669 10.0866C7.5748 9.89761 7.42739 9.77225 7.14682 9.74728C6.97594 9.73186 6.81877 9.74286 6.68486 9.77881L6.68383 9.77909Z" fill="#1F1F1F"/></svg>`;

  const focusIconSvg = `<svg width="32" height="40" viewBox="0 0 32 40" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse opacity="0.3" cx="16" cy="35.9995" rx="8.57031" ry="3.46338" fill="#1F1F1F"/><path d="M16 1C24.2843 1 31 7.71573 31 16C31 20.1762 28.929 24.2706 26.46 27.6914C23.9759 31.133 20.9955 34.0205 18.9785 35.8037C17.2617 37.3215 14.7383 37.3215 13.0215 35.8037C11.0045 34.0205 8.02413 31.133 5.54004 27.6914C3.07095 24.2706 1 20.1762 1 16C1 7.71573 7.71573 1 16 1Z" fill="#FFD800" stroke="#1F1F1F" stroke-width="2"/><circle cx="15.8599" cy="16.25" r="11.4233" fill="#F7F5F0"/><path d="M9.17773 15.7817L10.0764 18.7791C10.377 19.7838 11.1134 20.6014 12.0793 20.9951C14.8473 22.1243 17.5806 22.0591 20.2816 20.8C21.2238 20.3609 21.9129 19.5095 22.1576 18.492L22.8872 15.4554" fill="#FFD800"/><path d="M18.599 21.8747C16.3947 22.4666 14.1564 22.3064 11.9204 21.3944C10.8303 20.9493 10.0088 20.0409 9.66774 18.9021L8.76911 15.9048L9.58673 15.6596L10.4854 18.657C10.7511 19.544 11.3903 20.2506 12.2386 20.5968C14.8789 21.6744 17.5245 21.6116 20.1016 20.4092C20.9299 20.023 21.5286 19.2872 21.7436 18.3892L22.4732 15.3525L23.3027 15.5589L22.5731 18.5955C22.2963 19.7486 21.5268 20.6952 20.4627 21.1905C19.8455 21.4788 19.224 21.7058 18.5998 21.8734L18.599 21.8747Z" fill="#1F1F1F"/><path d="M23.602 14.148C23.5562 12.5046 20.1142 11.2532 15.9141 11.3528C11.7139 11.4524 8.34624 12.8654 8.39209 14.5088C8.43793 16.1522 11.88 17.4036 16.0801 17.304C20.2802 17.2043 23.6479 15.7913 23.602 14.148Z" fill="#FFD800"/><path d="M20.1813 17.1823C18.9659 17.5086 17.5609 17.7009 16.0928 17.7362C14.0103 17.786 12.0363 17.5125 10.536 16.9669C8.90606 16.3748 7.99348 15.5053 7.96551 14.521C7.91139 12.5796 11.3236 11.0327 15.9024 10.9233C17.985 10.8735 19.9589 11.147 21.4593 11.6926C23.0892 12.2848 24.0015 13.1532 24.0298 14.1386C24.0577 15.1229 23.1948 16.0344 21.5998 16.7034C21.1662 16.8856 20.6912 17.0454 20.1823 17.182L20.1813 17.1823ZM12.0305 12.3084C10.0147 12.8496 8.79583 13.7185 8.81701 14.5007C8.83337 15.0881 9.58265 15.7072 10.82 16.1573C12.2236 16.6676 14.0866 16.923 16.067 16.8749C18.0466 16.8282 19.8936 16.485 21.267 15.9079C22.4779 15.4 23.1912 14.746 23.1746 14.1575C23.1582 13.5701 22.409 12.9511 21.1717 12.5009C19.768 11.9907 17.905 11.7353 15.9246 11.7833C14.441 11.8183 13.119 12.015 12.0302 12.3074L12.0305 12.3084Z" fill="#1F1F1F"/><path d="M15.9882 14.0038C17.7856 13.9614 19.4895 14.1793 20.7867 14.6179C21.0783 14.7168 21.3204 14.8167 21.5224 14.9151C21.713 14.8105 21.8661 14.7103 21.9865 14.62C22.2776 14.4003 22.2651 13.959 21.9627 13.7538C21.7085 13.5802 21.3206 13.3779 20.7463 13.1844C19.4492 12.7458 17.7453 12.5279 15.9478 12.5703C14.1504 12.6127 12.4604 12.9115 11.1901 13.412C10.6198 13.6364 10.2406 13.8608 9.99672 14.0467C9.71538 14.2615 9.7275 14.6973 10.0208 14.8972C10.148 14.9845 10.3093 15.0794 10.5114 15.1779C10.7078 15.0705 10.9448 14.9578 11.2307 14.8465C12.5013 14.3471 14.1913 14.0483 15.9885 14.0049L15.9882 14.0038Z" fill="#1F1F1F"/><path d="M21.5359 15.3967L21.3391 15.3013C21.1371 15.2028 20.9057 15.1101 20.6519 15.0244C19.4008 14.6014 17.7476 14.3911 15.9995 14.4324C14.2505 14.4741 12.6118 14.7625 11.3862 15.2442C11.1375 15.3422 10.9125 15.4461 10.715 15.5537L10.5235 15.6586L10.3267 15.5633C10.1223 15.4643 9.9383 15.3588 9.7801 15.2508C9.52954 15.0785 9.37435 14.7925 9.36577 14.485C9.3572 14.1775 9.4962 13.885 9.73724 13.701C10.0652 13.4502 10.5018 13.2171 11.0323 13.0089C12.3478 12.4919 14.0891 12.1826 15.9347 12.1385C17.7802 12.0943 19.5361 12.3205 20.8793 12.7745C21.4138 12.9554 21.8587 13.1647 22.1992 13.3964C22.456 13.5716 22.6144 13.8611 22.6235 14.1707C22.6327 14.4803 22.4904 14.7771 22.2434 14.9638C22.0947 15.0761 21.9214 15.1873 21.7267 15.2931L21.5351 15.398L21.5359 15.3967ZM15.9753 13.573C17.8209 13.5289 19.5767 13.7551 20.9199 14.2091C21.1253 14.2788 21.3185 14.3528 21.4974 14.4307C21.5818 14.3791 21.6592 14.326 21.7291 14.2738C21.7641 14.2477 21.7704 14.2137 21.7697 14.1905C21.769 14.1673 21.7611 14.1337 21.7236 14.1092C21.5331 13.9798 21.1858 13.7844 20.6105 13.5912C19.3595 13.1681 17.7062 12.9578 15.9582 12.9992C14.2091 13.0409 12.5704 13.3293 11.3448 13.811C10.7745 14.0355 10.4365 14.2488 10.2531 14.3883C10.2227 14.411 10.2168 14.4426 10.2176 14.4658C10.218 14.488 10.2253 14.5195 10.2576 14.5409C10.3321 14.5922 10.4154 14.6434 10.5059 14.6927C10.6803 14.6057 10.8699 14.5225 11.0706 14.443C12.3871 13.9257 14.1274 13.6167 15.9729 13.5725L15.9753 13.573Z" fill="#1F1F1F"/><path d="M16.0459 16.0877C17.8434 16.0453 19.5333 15.7465 20.8037 15.246C21.0893 15.1337 21.3256 15.0223 21.5217 14.9139C21.3197 14.8155 21.0762 14.7148 20.786 14.6167C19.4888 14.1781 17.7849 13.9603 15.9875 14.0026C14.19 14.045 12.5 14.3439 11.2297 14.8443C10.9441 14.9567 10.7068 15.0683 10.5104 15.1756C10.7124 15.2741 10.9558 15.3748 11.2472 15.4726C12.5443 15.9112 14.2482 16.129 16.0457 16.0867L16.0459 16.0877Z" fill="#F7F5F0"/><path d="M19.8642 16.0062C18.7404 16.3079 17.4278 16.4864 16.0573 16.519C14.2117 16.5631 12.4559 16.3369 11.1126 15.8829C10.825 15.7863 10.5609 15.6788 10.3263 15.5658C10.1815 15.4954 10.0873 15.3502 10.0836 15.1885C10.0799 15.0267 10.1645 14.877 10.3051 14.8002C10.5334 14.6754 10.7907 14.5562 11.0725 14.446C12.3891 13.9287 14.1293 13.6197 15.9749 13.5755C17.8204 13.5314 19.5763 13.7576 20.9195 14.2116C21.2062 14.3085 21.4712 14.4156 21.7049 14.529C21.8496 14.5993 21.9438 14.7446 21.9475 14.9063C21.9522 15.0677 21.8666 15.2178 21.726 15.2945C21.4978 15.4193 21.2405 15.5386 20.9586 15.6488C20.6201 15.782 20.2525 15.9019 19.8631 16.0064L19.8642 16.0062ZM11.643 15.152C12.859 15.5187 14.4048 15.6988 16.0331 15.6595C17.6626 15.621 19.1958 15.3676 20.3894 14.9435C19.1734 14.5768 17.6276 14.3967 15.9994 14.436C14.3699 14.4745 12.8367 14.7279 11.643 15.152Z" fill="#1F1F1F"/><path d="M16.7038 16.0544C12.663 14.4289 13.5916 12.4544 11.4829 12.5425C10.1201 12.5997 10.1341 11.6732 9.18246 11.5876C8.23079 11.5021 7.55489 12.0859 7.72357 13.2242C7.86744 14.1919 8.60168 14.9688 9.54412 15.205C13.3347 16.1576 15.3868 16.282 16.7028 16.0546L16.7038 16.0544Z" fill="#F7F5F0"/><path d="M18.2662 16.2201L16.7774 16.4783C15.1892 16.7532 12.8591 16.4816 9.44255 15.6225C8.31046 15.338 7.46994 14.4203 7.30107 13.2854C7.17422 12.4346 7.45173 11.9299 7.70658 11.6575C8.05903 11.2798 8.59555 11.1023 9.21687 11.1584C9.76687 11.208 10.0862 11.48 10.3436 11.6984C10.6313 11.9433 10.86 12.1371 11.4619 12.1125C12.6718 12.0618 13.1047 12.621 13.6065 13.2686C14.1198 13.9299 14.8213 14.8359 16.8576 15.6544L18.2639 16.2196L18.2662 16.2201ZM8.68358 12.0472C8.53835 12.0861 8.41853 12.154 8.33001 12.248C8.10179 12.492 8.10416 12.8792 8.14563 13.1612C8.26118 13.937 8.86383 14.5899 9.64553 14.7868C11.9193 15.3587 13.6809 15.6637 15.0362 15.7143C13.8911 15.0277 13.3571 14.3386 12.9365 13.7962C12.4803 13.2076 12.2727 12.9402 11.5027 12.972C10.5669 13.0115 10.1399 12.6469 9.79645 12.3546C9.57455 12.1657 9.42715 12.0403 9.14658 12.0153C8.97569 11.9999 8.81852 12.0109 8.68462 12.0469L8.68358 12.0472Z" fill="#1F1F1F"/></svg>`;

  const normalIconUrl =
    "data:image/svg+xml;charset=utf-8," + encodeURIComponent(normalIconSvg);
  const focusIconUrl =
    "data:image/svg+xml;charset=utf-8," + encodeURIComponent(focusIconSvg);

  return `
    (function() {
      window.alert = function() { return true; };
      window.console.log = function() {};

      const container = document.getElementById('map');
      const options = {
        center: new kakao.maps.LatLng(${region.latitude}, ${region.longitude}),
        level: 3,
        draggable: true,
        scrollwheel: true,
        disableDoubleClickZoom: false
      };
      const map = new kakao.maps.Map(container, options);
      window.kakaoMap = map;

      const normalImageSize = new kakao.maps.Size(28, 38);
      const normalImageOption = { offset: new kakao.maps.Point(14, 38) };
      const normalImage = new kakao.maps.MarkerImage('${normalIconUrl}', normalImageSize, normalImageOption);

      const focusImageSize = new kakao.maps.Size(32, 40);
      const focusImageOption = { offset: new kakao.maps.Point(16, 40) };
      const focusImage = new kakao.maps.MarkerImage('${focusIconUrl}', focusImageSize, focusImageOption);

      let focusedMarkerId = null;
      const markerObjects = {};

      const markersData = ${JSON.stringify(webViewMarkers)};
      markersData.forEach(marker => {
        const position = new kakao.maps.LatLng(marker.latitude, marker.longitude);
        const m = new kakao.maps.Marker({
          position,
          map,
          image: normalImage
        });

        markerObjects[marker.id] = m;

        kakao.maps.event.addListener(m, 'click', function() {
          if (focusedMarkerId && markerObjects[focusedMarkerId]) {
            markerObjects[focusedMarkerId].setImage(normalImage);
          }

          m.setImage(focusImage);
          focusedMarkerId = marker.id;

          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'markerPress',
            markerId: marker.id
          }));
        });
      });

      kakao.maps.event.addListener(map, 'click', function() {
        if (focusedMarkerId && markerObjects[focusedMarkerId]) {
          markerObjects[focusedMarkerId].setImage(normalImage);
          focusedMarkerId = null;
        }

        window.ReactNativeWebView.postMessage(JSON.stringify({
          type: 'mapPress'
        }));
      });

      let idleTimeout = null;
      kakao.maps.event.addListener(map, 'idle', function() {
        if (idleTimeout) {
          clearTimeout(idleTimeout);
        }

        idleTimeout = setTimeout(function() {
          const bounds = window.kakaoMap.getBounds();
          const sw = bounds.getSouthWest();
          const ne = bounds.getNorthEast();

          const latRange = ne.getLat() - sw.getLat();
          const lngRange = ne.getLng() - sw.getLng();

          const expandFactor = 0.2;
          const expandedMinLat = sw.getLat() - (latRange * expandFactor);
          const expandedMaxLat = ne.getLat() + (latRange * expandFactor);
          const expandedMinLng = sw.getLng() - (lngRange * expandFactor);
          const expandedMaxLng = ne.getLng() + (lngRange * expandFactor);

          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'idleRegion',
            region: {
              minLatitude: expandedMinLat,
              maxLatitude: expandedMaxLat,
              minLongitude: expandedMinLng,
              maxLongitude: expandedMaxLng,
              centerLatitude: (expandedMinLat + expandedMaxLat) / 2,
              centerLongitude: (expandedMinLng + expandedMaxLng) / 2
            }
          }));
        }, 300);
      });

      function moveToCenter(lat, lng) {
        const moveLatLon = new kakao.maps.LatLng(lat, lng);
        window.kakaoMap.panTo(moveLatLon);
      }

      function updateMarkers(newMarkers) {

        const newMarkerIds = new Set(newMarkers.map(function(m) { return String(m.id); }));
        const existingMarkerIds = new Set(Object.keys(markerObjects));

        existingMarkerIds.forEach(function(id) {
          if (!newMarkerIds.has(id)) {
            markerObjects[id].setMap(null);
            delete markerObjects[id];
            if (focusedMarkerId === id) {
              focusedMarkerId = null;
            }
          }
        });

        newMarkers.forEach(function(marker) {
          var id = String(marker.id);
          if (!existingMarkerIds.has(id)) {
            var position = new kakao.maps.LatLng(marker.latitude, marker.longitude);
            var m = new kakao.maps.Marker({
              position: position,
              map: window.kakaoMap,
              image: normalImage
            });

            markerObjects[id] = m;

            kakao.maps.event.addListener(m, 'click', function() {
              if (focusedMarkerId && markerObjects[focusedMarkerId]) {
                markerObjects[focusedMarkerId].setImage(normalImage);
              }

              m.setImage(focusImage);
              focusedMarkerId = id;

              window.ReactNativeWebView.postMessage(JSON.stringify({
                type: 'markerPress',
                markerId: marker.id
              }));
            });
          }
        });
      }

      function onMessage(e) {
        try {
          const data = JSON.parse(e.data);
          if (data.type === 'moveCenter') {
            moveToCenter(data.latitude, data.longitude);
          } else if (data.type === 'focusMarker') {
            if (focusedMarkerId && markerObjects[focusedMarkerId]) {
              markerObjects[focusedMarkerId].setImage(normalImage);
            }

            if (data.markerId && markerObjects[data.markerId]) {
              markerObjects[data.markerId].setImage(focusImage);
              focusedMarkerId = data.markerId;
            }
          } else if (data.type === 'updateMarkers') {
            updateMarkers(data.markers);
          } else if (data.type === 'getCurrentRegion') {
            const center = window.kakaoMap.getCenter();
            const bounds = window.kakaoMap.getBounds();
            const sw = bounds.getSouthWest();
            const ne = bounds.getNorthEast();

            const latitudeDelta = ne.getLat() - sw.getLat();
            const longitudeDelta = ne.getLng() - sw.getLng();

            window.ReactNativeWebView.postMessage(JSON.stringify({
              type: 'currentRegion',
              latitude: center.getLat(),
              longitude: center.getLng(),
              latitudeDelta: latitudeDelta,
              longitudeDelta: longitudeDelta
            }));
          }
        } catch (err) {
        }
      }

      window.addEventListener('message', onMessage);
      document.addEventListener('message', onMessage);
    })();
  `;
};

export const generateMapHtml = (
  region: MapRegion,
  markers: MapMarker[],
  apiKey: string,
) => {
  return `
    ${generateHtmlStructure(apiKey)}
    <script>${generateInitScript(region, markers)}</script>
    </body>
    </html>
  `.trim();
};
